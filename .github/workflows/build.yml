name: Build IDA Plugin

on:
  push:
    branches: [master, github-ci-2]
  pull_request:
    branches: [master]

jobs:
  # IDA 9.2 builds (Qt6)
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build \
            libgl1-mesa-dev libxcb-xinerama0-dev libxkbcommon-dev \
            libxcb-cursor-dev libxcb-icccm4-dev libxcb-image0-dev \
            libxcb-keysyms1-dev libxcb-randr0-dev libxcb-render-util0-dev \
            libxcb-shape0-dev libxcb-sync-dev libxcb-xfixes0-dev \
            libfontconfig1-dev libfreetype6-dev libx11-dev libx11-xcb-dev \
            libxext-dev libxfixes-dev libxi-dev libxrender-dev libxkbcommon-x11-dev

      - name: Install HCLI
        run: pip install ida-hcli==0.14.2

      - name: Download IDA SDK
        env:
          HCLI_API_KEY: ${{ secrets.HCLI_API_KEY }}
        run: |
          hcli --disable-updates download release/9.2/sdk-and-utilities/idasdk92.zip
          unzip -q idasdk92.zip -d ./ida-temp
          mv ./ida-temp/src ./ida-sdk
          ln -s ${{ github.workspace }}/palette/ida-cmake ${{ github.workspace }}/ida-sdk/ida-cmake

      - name: Download and Install IDA Free
        env:
          HCLI_API_KEY: ${{ secrets.HCLI_API_KEY }}
        run: |
          hcli --disable-updates download release/9.2/ida-free/ida-free-pc_92_x64linux.run
          chmod +x ida-free-pc_92_x64linux.run
          ./ida-free-pc_92_x64linux.run --mode unattended --prefix ${{ github.workspace }}/ida

      - name: Cache Qt6 build
        uses: actions/cache@v4
        id: qt-cache
        with:
          path: qt-install
          key: ${{ runner.os }}-qt6-6.8.2-qtnamespace-v1
          restore-keys: |
            ${{ runner.os }}-qt6-

      - name: Build Qt6 from source (if not cached)
        if: steps.qt-cache.outputs.cache-hit != 'true'
        run: |
          # Download Qt source
          curl -L -o qt-src.tar.xz https://download.qt.io/archive/qt/6.8/6.8.2/single/qt-everywhere-src-6.8.2.tar.xz
          tar xf qt-src.tar.xz

          # Configure Qt with QT_NAMESPACE=QT (required for IDA)
          cmake -S qt-everywhere-src-6.8.2 -B qt-build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/qt-install \
            -DQT_BUILD_EXAMPLES=OFF \
            -DQT_BUILD_TESTS=OFF \
            -DQT_NAMESPACE=QT \
            -DQT_BUILD_SUBMODULES=qtbase \
            -DFEATURE_gui=ON \
            -DFEATURE_widgets=ON \
            -DFEATURE_opengl=ON \
            -DFEATURE_network=OFF \
            -DFEATURE_sql=OFF \
            -DFEATURE_dbus=OFF \
            -DFEATURE_concurrent=OFF \
            -DFEATURE_printsupport=OFF

          # Build and install
          cmake --build qt-build --parallel
          cmake --install qt-build

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/qt-install \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DPYTHON_SUPPORT=OFF \
            -DIDASDK=${{ github.workspace }}/ida-sdk \
            -DIDABIN=${{ github.workspace }}/ida \
            -DEA64=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ifred-linux-64
          path: ${{ github.workspace }}/ida/plugins/ida_palette*.so
          retention-days: 1

  # IDA 8.4 builds (Qt5)
  build-linux-ida84:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build \
            libgl1-mesa-dev libxcb-xinerama0-dev libxkbcommon-dev \
            libxcb-cursor-dev libxcb-icccm4-dev libxcb-image0-dev \
            libxcb-keysyms1-dev libxcb-randr0-dev libxcb-render-util0-dev \
            libxcb-shape0-dev libxcb-sync-dev libxcb-xfixes0-dev \
            libfontconfig1-dev libfreetype6-dev libx11-dev libx11-xcb-dev \
            libxext-dev libxfixes-dev libxi-dev libxrender-dev libxkbcommon-x11-dev

      - name: Download IDA SDK
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download sdk-assets --pattern 'idasdk_pro84.zip' --repo ${{ github.repository }}
          unzip -q idasdk_pro84.zip
          mv idasdk_pro84 ida-sdk
          ln -s ${{ github.workspace }}/palette/ida-cmake ${{ github.workspace }}/ida-sdk/ida-cmake
          # Fix IDA 8.4 SDK lib paths (has _pro suffix and libida64 naming)
          cd ida-sdk/lib
          ln -s x64_linux_gcc_64_pro x64_linux_gcc_64
          ln -s x64_linux_gcc_32_pro x64_linux_gcc_32
          ln -s x64_linux_gcc_64_pro/libida64.so x64_linux_gcc_64_pro/libida.so

      - name: Cache Qt5 build
        uses: actions/cache@v4
        id: qt-cache
        with:
          path: qt-install
          key: ${{ runner.os }}-qt5-5.15.2-qtnamespace-v1
          restore-keys: |
            ${{ runner.os }}-qt5-

      - name: Build Qt5 from source (if not cached)
        if: steps.qt-cache.outputs.cache-hit != 'true'
        run: |
          # Download Qt5 source
          curl -L -o qt-src.tar.xz https://download.qt.io/archive/qt/5.15/5.15.2/single/qt-everywhere-src-5.15.2.tar.xz
          tar xf qt-src.tar.xz

          # Configure Qt5 with QT_NAMESPACE=QT (required for IDA)
          cd qt-everywhere-src-5.15.2
          ./configure -prefix ${{ github.workspace }}/qt-install \
            -opensource -confirm-license \
            -release \
            -qtnamespace QT \
            -skip qtwebengine -skip qt3d -skip qtcharts -skip qtdatavis3d \
            -skip qtgamepad -skip qtlocation -skip qtmultimedia -skip qtpurchasing \
            -skip qtremoteobjects -skip qtscript -skip qtsensors -skip qtserialbus \
            -skip qtserialport -skip qtspeech -skip qtvirtualkeyboard -skip qtwayland \
            -skip qtwebchannel -skip qtwebsockets -skip qtwebview \
            -nomake examples -nomake tests

          # Build and install
          make -j$(nproc)
          make install

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/qt-install \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DPYTHON_SUPPORT=OFF \
            -DUSE_QT5=ON \
            -DIDASDK=${{ github.workspace }}/ida-sdk \
            -DEA64=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ifred-linux-64-ida84
          path: ${{ github.workspace }}/ida-sdk/bin/plugins/ida_palette*.so
          retention-days: 1

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Visual Studio Developer Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install HCLI
        run: pip install ida-hcli==0.14.2

      - name: Download IDA SDK
        shell: bash
        env:
          HCLI_API_KEY: ${{ secrets.HCLI_API_KEY }}
        run: |
          hcli --disable-updates download release/9.2/sdk-and-utilities/idasdk92.zip
          unzip -q idasdk92.zip -d ./ida-temp
          mv ./ida-temp/src ./ida-sdk
          cp -r palette/ida-cmake ida-sdk/ida-cmake

      - name: Cache Qt6 build
        uses: actions/cache@v4
        id: qt-cache
        with:
          path: qt-install
          key: ${{ runner.os }}-qt6-6.8.2-qtnamespace-v1
          restore-keys: |
            ${{ runner.os }}-qt6-

      - name: Build Qt6 from source (if not cached)
        if: steps.qt-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          # Download Qt source
          curl -L -o qt-src.tar.xz https://download.qt.io/archive/qt/6.8/6.8.2/single/qt-everywhere-src-6.8.2.tar.xz
          tar xf qt-src.tar.xz

          # Configure Qt with QT_NAMESPACE=QT (required for IDA)
          cmake -S qt-everywhere-src-6.8.2 -B qt-build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/qt-install" \
            -DQT_BUILD_EXAMPLES=OFF \
            -DQT_BUILD_TESTS=OFF \
            -DQT_NAMESPACE=QT \
            -DQT_BUILD_SUBMODULES=qtbase \
            -DFEATURE_gui=ON \
            -DFEATURE_widgets=ON \
            -DFEATURE_opengl=ON \
            -DFEATURE_network=OFF \
            -DFEATURE_sql=OFF \
            -DFEATURE_dbus=OFF \
            -DFEATURE_concurrent=OFF \
            -DFEATURE_printsupport=OFF

          # Build and install
          cmake --build qt-build --parallel
          cmake --install qt-build

      - name: Configure CMake
        shell: bash
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/qt-install" \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DPYTHON_SUPPORT=OFF \
            -DIDASDK="${{ github.workspace }}/ida-sdk" \
            -DEA64=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Upload artifacts (64-bit)
        uses: actions/upload-artifact@v4
        with:
          name: ifred-windows-64
          path: ${{ github.workspace }}/ida-sdk/bin/plugins/ida_palette*.dll
          retention-days: 1

  build-windows-ida84:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Visual Studio Developer Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Download IDA SDK
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download sdk-assets --pattern 'idasdk_pro84.zip' --repo ${{ github.repository }}
          unzip -q idasdk_pro84.zip
          mv idasdk_pro84 ida-sdk
          cp -r palette/ida-cmake ida-sdk/ida-cmake
          # Fix IDA 8.4 SDK lib paths (has _pro suffix)
          cd ida-sdk/lib
          cp -r x64_win_vc_64_pro x64_win_vc_64
          cp -r x64_win_vc_32_pro x64_win_vc_32

      - name: Cache Qt5 build
        uses: actions/cache@v4
        id: qt-cache
        with:
          path: qt-install
          key: ${{ runner.os }}-qt5-5.15.2-qtnamespace-v1
          restore-keys: |
            ${{ runner.os }}-qt5-

      - name: Install jom
        if: steps.qt-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          curl -L -o jom.zip https://download.qt.io/official_releases/jom/jom_1_1_4.zip
          unzip jom.zip -d jom
          echo "${{ github.workspace }}/jom" >> $GITHUB_PATH

      - name: Build Qt5 from source (if not cached)
        if: steps.qt-cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          curl -L -o qt-src.zip https://download.qt.io/archive/qt/5.15/5.15.2/single/qt-everywhere-src-5.15.2.zip
          7z x qt-src.zip

          cd qt-everywhere-src-5.15.2
          call configure.bat -prefix "${{ github.workspace }}/qt-install" ^
            -opensource -confirm-license ^
            -release ^
            -qtnamespace QT ^
            -skip qtwebengine -skip qt3d -skip qtcharts -skip qtdatavis3d ^
            -skip qtgamepad -skip qtlocation -skip qtmultimedia -skip qtpurchasing ^
            -skip qtremoteobjects -skip qtscript -skip qtsensors -skip qtserialbus ^
            -skip qtserialport -skip qtspeech -skip qtvirtualkeyboard -skip qtwayland ^
            -skip qtwebchannel -skip qtwebsockets -skip qtwebview ^
            -nomake examples -nomake tests

          ${{ github.workspace }}\jom\jom.exe -j%NUMBER_OF_PROCESSORS%
          ${{ github.workspace }}\jom\jom.exe install

      - name: Configure CMake
        shell: bash
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/qt-install" \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DPYTHON_SUPPORT=OFF \
            -DUSE_QT5=ON \
            -DIDASDK="${{ github.workspace }}/ida-sdk" \
            -DEA64=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Upload artifacts (64-bit)
        uses: actions/upload-artifact@v4
        with:
          name: ifred-windows-64-ida84
          path: ${{ github.workspace }}/ida-sdk/bin/plugins/ida_palette*.dll
          retention-days: 1

  build-macos:
    runs-on: macos-latest  # arm64 runner
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: brew install cmake ninja

      - name: Install HCLI
        run: pip3 install ida-hcli==0.14.2 --break-system-packages

      - name: Download IDA SDK
        env:
          HCLI_API_KEY: ${{ secrets.HCLI_API_KEY }}
        run: |
          hcli --disable-updates download release/9.2/sdk-and-utilities/idasdk92.zip
          unzip -q idasdk92.zip -d ./ida-temp
          mv ./ida-temp/src ./ida-sdk
          ln -s ${{ github.workspace }}/palette/ida-cmake ${{ github.workspace }}/ida-sdk/ida-cmake

      - name: Download and Install IDA Free
        env:
          HCLI_API_KEY: ${{ secrets.HCLI_API_KEY }}
        run: |
          hcli --disable-updates download "release/9.2/ida-free/ida-free-pc_92_armmac.app.zip"
          unzip -q ida-free-pc_92_armmac.app.zip
          ./ida-free-pc_92_armmac.app/Contents/MacOS/installbuilder.sh --mode unattended --prefix ${{ github.workspace }}/ida-install

      - name: Cache Qt6 build
        uses: actions/cache@v4
        id: qt-cache
        with:
          path: qt-install
          key: ${{ runner.os }}-qt6-6.8.2-arm64-qtnamespace-v1
          restore-keys: |
            ${{ runner.os }}-qt6-arm64-

      - name: Build Qt6 from source (if not cached)
        if: steps.qt-cache.outputs.cache-hit != 'true'
        run: |
          # Download Qt source
          curl -L -o qt-src.tar.xz https://download.qt.io/archive/qt/6.8/6.8.2/single/qt-everywhere-src-6.8.2.tar.xz
          tar xf qt-src.tar.xz

          # Configure Qt with QT_NAMESPACE=QT (required for IDA)
          cmake -S qt-everywhere-src-6.8.2 -B qt-build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/qt-install \
            -DCMAKE_OSX_ARCHITECTURES="arm64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
            -DQT_BUILD_EXAMPLES=OFF \
            -DQT_BUILD_TESTS=OFF \
            -DQT_NAMESPACE=QT \
            -DQT_BUILD_SUBMODULES=qtbase \
            -DFEATURE_gui=ON \
            -DFEATURE_widgets=ON \
            -DFEATURE_opengl=ON \
            -DFEATURE_network=OFF \
            -DFEATURE_sql=OFF \
            -DFEATURE_dbus=OFF \
            -DFEATURE_concurrent=OFF \
            -DFEATURE_printsupport=OFF

          # Build and install
          cmake --build qt-build --parallel
          cmake --install qt-build

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/qt-install \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_OSX_ARCHITECTURES="arm64" \
            -DPYTHON_SUPPORT=OFF \
            -DIDASDK=${{ github.workspace }}/ida-sdk \
            -DIDABIN="${{ github.workspace }}/ida-install/IDA Free 9.2.app/Contents/MacOS" \
            -DEA64=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ifred-macos-arm64
          path: "${{ github.workspace }}/ida-install/IDA Free 9.2.app/Contents/MacOS/plugins/ida_palette*.dylib"
          retention-days: 1

  build-macos-ida84:
    runs-on: macos-13  # x64 runner for IDA 8.4
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: brew install cmake ninja gh

      - name: Download IDA SDK
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download sdk-assets --pattern 'idasdk_pro84.zip' --repo ${{ github.repository }}
          unzip -q idasdk_pro84.zip
          mv idasdk_pro84 ida-sdk
          ln -s ${{ github.workspace }}/palette/ida-cmake ${{ github.workspace }}/ida-sdk/ida-cmake
          # Fix IDA 8.4 SDK lib paths (has _pro suffix and libida64 naming)
          cd ida-sdk/lib
          ln -s x64_mac_clang_64_pro x64_mac_clang_64
          ln -s x64_mac_clang_32_pro x64_mac_clang_32
          ln -s x64_mac_clang_64_pro/libida64.dylib x64_mac_clang_64_pro/libida.dylib

      - name: Cache Qt5 build
        uses: actions/cache@v4
        id: qt-cache
        with:
          path: qt-install
          key: ${{ runner.os }}-qt5-5.15.2-x64-qtnamespace-v1
          restore-keys: |
            ${{ runner.os }}-qt5-x64-

      - name: Build Qt5 from source (if not cached)
        if: steps.qt-cache.outputs.cache-hit != 'true'
        run: |
          # Download Qt5 source
          curl -L -o qt-src.tar.xz https://download.qt.io/archive/qt/5.15/5.15.2/single/qt-everywhere-src-5.15.2.tar.xz
          tar xf qt-src.tar.xz

          # Configure Qt5 with QT_NAMESPACE=QT (required for IDA)
          cd qt-everywhere-src-5.15.2
          ./configure -prefix ${{ github.workspace }}/qt-install \
            -opensource -confirm-license \
            -release \
            -qtnamespace QT \
            -skip qtwebengine -skip qt3d -skip qtcharts -skip qtdatavis3d \
            -skip qtgamepad -skip qtlocation -skip qtmultimedia -skip qtpurchasing \
            -skip qtremoteobjects -skip qtscript -skip qtsensors -skip qtserialbus \
            -skip qtserialport -skip qtspeech -skip qtvirtualkeyboard -skip qtwayland \
            -skip qtwebchannel -skip qtwebsockets -skip qtwebview \
            -nomake examples -nomake tests

          # Build and install
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/qt-install \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_OSX_ARCHITECTURES="x86_64" \
            -DPYTHON_SUPPORT=OFF \
            -DUSE_QT5=ON \
            -DIDASDK=${{ github.workspace }}/ida-sdk \
            -DEA64=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ifred-macos-x64-ida84
          path: ${{ github.workspace }}/ida-sdk/bin/plugins/ida_palette*.dylib
          retention-days: 1

  package:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-linux-ida84, build-windows-ida84, build-macos-ida84]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create plugin packages
        run: |
          # IDA 9.2 package (Qt6)
          mkdir -p package-ida92
          cp ida-plugin.json package-ida92/
          cp README.md package-ida92/
          cp artifacts/ifred-linux-64/*.so package-ida92/
          cp artifacts/ifred-windows-64/*.dll package-ida92/
          cp artifacts/ifred-macos-arm64/*.dylib package-ida92/

          # IDA 8.4 package (Qt5)
          mkdir -p package-ida84
          cp ida-plugin.json package-ida84/
          cp README.md package-ida84/
          cp artifacts/ifred-linux-64-ida84/*.so package-ida84/
          cp artifacts/ifred-windows-64-ida84/*.dll package-ida84/
          cp artifacts/ifred-macos-x64-ida84/*.dylib package-ida84/

      - name: Upload IDA 9.2 plugin package
        uses: actions/upload-artifact@v4
        with:
          name: ifred-plugin-ida92
          path: package-ida92/*

      - name: Upload IDA 8.4 plugin package
        uses: actions/upload-artifact@v4
        with:
          name: ifred-plugin-ida84
          path: package-ida84/*

      - name: Delete intermediate artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            ifred-linux-64
            ifred-windows-64
            ifred-macos-arm64
            ifred-linux-64-ida84
            ifred-windows-64-ida84
            ifred-macos-x64-ida84
